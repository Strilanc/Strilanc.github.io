<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="author" content="Craig Gidney">
    <meta name="keywords" content="computer science,algorithms,quantum computing,blog">
    <meta name="description" content="Craig Gidney's computer science blog">
    <title>Rule of Thumb: Preconditions Should be Public</title>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <meta name="viewport" content="width=device-width">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <!-- RSS autodiscovery -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

    <!-- Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-48771413-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <div class="header">
      <a href="/"><img src="/assets/banner.png" alt="Algorithmic Assertions - Craig Gidney's Computer Science Blog" id="site_banner"/></a>
    </div>
    <div class="site">

      <h1 class="post_title">Rule of Thumb: Preconditions Should be Public</h1>
<p class="meta">22 Jun 2014</p>

    <!-- MathJax latest -->
    <script async type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$','$']],
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        },
        TeX: {
          Macros: {
            ket: ["\\left|{#1}\\right\\rangle", 1],
            bra: ["\\left\\langle{#1}\\right|", 1],
            parens: ["\\left({#1}\\right)", 1],
            bracket: ["\\left[{#1}\\right]", 1],
            brace: ["\\left\\{ {#1} \\right\\}", 1],
            Sum: ["\\underset{#1}{\\overset{#2}{\\Sigma}}", 2],
            bimat: ["\\begin{bmatrix} {#1} & {#2} \\\\ {#3} & {#4} \\end{bmatrix}", 4]
          }
        }
      });
    </script>
    <noscript>
      <font color=red>
        MathJax was blocked.
        Formulas like <strong>$\frac{a}{b}$</strong> won't render into <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAYCAIAAACjjJBEAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAFnSURBVDhPY/hPCCBU/P1wamJqZFpBTnJcqLl9142fUHGYip93Znopuc55+Pv/zyv16kJ+W99DJaAq/r3bGiLA67cFJPxuo5eI8bSHf8ASQABR8e1krhSr+ZwnQOGvx9LlFPNPvnv37vs/sBxExc/rrToy8Ye+/P/7ekeKFK/H2guLsvuvQlwCdcefF1sKPX3ic8qaJkzKsTcPSKzY8PQ3RArmUtyAWioYcAOoCvyAyiq+nusIVGdl0O6+/QsqAgYoZnw5nCSlkHfqG5QLAcgqflyuVZeI3PMJyoUCJBV/Hk43YRFySSvIDHXyrNr75i9EGKHi35t1HvxKxUc+/vv/cYe/qNGEu5CIQaj4cjBBSrn03HewYUZsStWXfoDF4Sp+351gKB688yMwOb5c4cwlmngA6h64ir9P59lr5Jz89v/nrQnWsl4LH0MjH8mWvx9OdEUFJ6TEhGXPu/IFkr5AAKECO/j/HwCRTZMPA+AaqQAAAABJRU5ErkJggg==" />.
      </font>
      <br>
      Allow scripts from <strong>algorithmicassertions.com</strong> and <strong>mathjax.org</strong> to fix.
      <hr/>
    </noscript>

<div class="post">
<p>In software, it&#39;s common to have operations that only make sense when an object is in a particular state. For example, in a guess-how-many-jelly-beans-are-in-the-jar contest, you&#39;re typically not allowed to guess the same number as someone else. Also, there can&#39;t be a winner if no one has guessed. So if you write a class to handle that sort of contest, you naturally end up with code checking for those conditions:</p>
<div class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">class</span> <span class="nf">JellyBeanGuessingContest</span><span class="p">(</span><span class="k">private</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">actualAmount</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Person</span><span class="p">&gt;</span> <span class="n">guesses</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Person</span><span class="p">&gt;();</span>

  <span class="k">public</span> <span class="k">void</span> <span class="nf">addGuess</span><span class="p">(</span><span class="kt">int</span> <span class="n">amount</span><span class="p">,</span> <span class="n">Person</span> <span class="n">person</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">guesses</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">PreconditionFailed</span><span class="p">(</span><span class="s">&quot;duplicate guess&quot;</span><span class="p">);</span>
    <span class="n">guesses</span><span class="p">[</span><span class="n">amount</span><span class="p">]</span> <span class="p">=</span> <span class="n">person</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="n">Person</span> <span class="nf">getWinner</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">guesses</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">PreconditionFailed</span><span class="p">(</span><span class="s">&quot;no guesses&quot;</span><span class="p">);</span>
    <span class="c1">// (in the event of a g+d vs g-d tie, the larger guess wins because I said so)</span>
    <span class="k">return</span> <span class="n">guesses</span><span class="p">.</span><span class="n">MaxBy</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">Math</span><span class="p">.</span><span class="n">Abs</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Key</span> <span class="p">-</span> <span class="n">actualAmount</span> <span class="p">+</span> <span class="m">0.25</span><span class="p">)).</span><span class="n">Value</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The problem here is that whatever is calling this class has no way of checking <em>for itself</em> if the operations will succeed or fail. The only way to determine if an amount has already been guessed is to try to make that guess and fail, and the only way to know there isn&#39;t a winner is to fail at getting the winner. We have <em>private</em> preconditions on <em>public</em> methods.</p>

<p>&quot;Can&#39;t guess that&quot; and &quot;no winner yet&quot; are important cases that the caller is going to want to handle. Exceptions shine when failure is propagated, not when it&#39;s handled, so they&#39;re the wrong mechanism for informing the caller here. Basically we&#39;re forcing callers to use try-catch blocks, instead of if-else blocks, and that&#39;s bad because try-catch blocks are bloated and fickle. They take longer to write, longer to execute, and more effort to review (because you can&#39;t tell if they&#39;re correct without digging into documentation).</p>

<p>In other words, our exceptions aren&#39;t actually exceptional. We want to blame the caller for calling at the wrong time, but we&#39;re not giving them the tools to <em>not</em> call at the wrong time, so we expect to throw exceptions during normal usage. This makes it harder to detect exceptions thrown due to bugs (e.g. asking your debugger to pause when an exception is thrown becomes effectively useless).</p>

<p>Another benefit of public preconditions is that they provide a shared language with which to communicate the problem. You don&#39;t have to say &quot;there were no guesses&quot;, you can <a href="http://strilanc.com/heuristic/2014/03/31/The-Condition-Is-the-Message.html">turn the condition into the message</a> and unambiguously say &quot;here is the exact expression that you can evaluate that should have been true&quot;.</p>

<p>Taking all of that into account, we should really rewrite our class to have public preconditions:</p>
<div class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">class</span> <span class="nf">JellyBeanGuessingContest</span><span class="p">(</span><span class="k">private</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">numberOfJellyBeans</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Person</span><span class="p">&gt;</span> <span class="n">guesses</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Person</span><span class="p">&gt;();</span>

  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">hasAnyoneGuessedAnything</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">guesses</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">hasAnyoneGuessedAmount</span><span class="p">(</span><span class="kt">int</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">guesses</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">void</span> <span class="nf">addGuess</span><span class="p">(</span><span class="kt">int</span> <span class="n">amount</span><span class="p">,</span> <span class="n">Person</span> <span class="n">person</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hasAnyoneGuessedAmount</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">PreconditionFailed</span><span class="p">(</span><span class="s">&quot;!hasAnyoneGuessedAmount(amount)&quot;</span><span class="p">);</span>
    <span class="n">guesses</span><span class="p">[</span><span class="n">amount</span><span class="p">]</span> <span class="p">=</span> <span class="n">person</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="n">Person</span> <span class="nf">getWinner</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">hasAnyoneGuessedAnything</span><span class="p">())</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">PreconditionFailed</span><span class="p">(</span><span class="s">&quot;hasAnyoneGuessedAnything()&quot;</span><span class="p">)</span>
    <span class="c1">// (in the event of a g+d vs g-d tie, the larger guess wins because I said so)</span>
    <span class="k">return</span> <span class="n">guesses</span><span class="p">.</span><span class="n">MaxBy</span><span class="p">(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">Math</span><span class="p">.</span><span class="n">Abs</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Key</span> <span class="p">-</span> <span class="n">numberOfJellyBeans</span> <span class="p">+</span> <span class="m">0.25</span><span class="p">)).</span><span class="n">Value</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Generally speaking, making preconditions public is a good idea. The cases where it&#39;s not correspond well with &quot;actually exceptional&quot; exceptions. For example, no one would bother checking &quot;has this iterator been invalidated due to the collection being modified?&quot;. That&#39;s almost always caused by a bug, meaning we probably can&#39;t handle the problem, and the correct response matches what exceptions do: propagate failure.</p>

<p>All that being said, you should also consider whether having these preconditions in the first place is a good idea. Instead of making them public, you can remove them entirely. <code>addGuess</code> can be changed into <code>tryAddGuess</code> and return a boolean that indicates if it succeeded. <code>getWinner</code> can return null, or an empty <code>Maybe&lt;Person&gt;</code>, when there&#39;s no winner. But <em>if</em> you decide to have preconditions, <em>then</em> they should be public.</p>

<p><strong>Summary</strong></p>

<p>If a caller is expected to satisfy a precondition, make the precondition public so they can check it themselves. This doesn&#39;t just make the throw unambiguously their fault, it makes it easier to communicate and debug what&#39;s wrong.</p>

<p>Making preconditions public is especially important when using languages or tools that treat them as part of a method&#39;s signature. For example, <a href="http://research.microsoft.com/en-us/projects/contracts/">.Net code contracts</a> require that members used in a contract expression be at least as visible as what the contract applies to.</p>

<p><em>edit</em> Expanded the paragraph mentioning alternative designs. The message here is &quot;don&#39;t have private preconditions&quot;, not &quot;use lots of preconditions!&quot;. Avoiding preconditions entirely is also good.</p>

</div>

<!-- IntenseDebate comments -->




    </div>

    <table style="width: 100%;">
      <tr>
        <td align="left">
          <a href="/game-theory/2014/06/17/Counterintuitive-Counterfactual-Strategies.html">&laquo; Counter-intuitive Counterfactual Strategies</a>
        </td>
        <td align="right">
          <a href="/puzzle/2014/07/08/Boxing-Megaspheres.html">Puzzle: Boxing Megaspheres &raquo;</a>
        </td>
      </tr>
    </table>

    <div class="footer-container">
      <div class="site">
        <div class="footer">
          <div class="contact">
            by: Craig Gidney<br />
            more: <a href="/">All Posts</a>, <a href="/feed.xml">Posts Feed<img src="/assets/feed-icon.png" width="16px" alt="Posts Feed" title="Posts Feed" /></a><br/>
            meta: <a href="/about.html">About the Author/Blog</a><br/>
          </div>
          <div class="license">
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
              <img alt="Creative Commons License" style="border-width:0" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAAfCAYAAABjyArgAAAFOklEQVRo3u1aTU8bRxj2OVIs7lw4hhttlR5TpPQHkB+QiH9Q1FskqqCIVIpUCVmuoubQUKm3JrDG5sNfeA1rY3vX9noh5MpP4Ce81fOu32V2WfAHzhoTRhqx3pmdHZ595nk/ZmJEFI/FYnRfR1+J8Kf7Yye/TXvFXcqVslQ8KFDJKNFBtUxG3aAjs0r1Zo0arQZZbZOatkXNTtOttkWWbZLZanAf9K3UDX5WN0o8Vq6U47Hxjkw2TVt7KUrtaLS5vUEbmU9cP6U/0set/+5MVYC+ADev52j/sEjlik5G7ZDBarTqDGDbaVHnxCbnc4eOT4/p5Itbce18drgNfSzb4mfwLMYoV3UeE2MHQdZ2Nj2QAfAdBTnmB7daZgbWrBqzFaAB1NU3q/T056f0MP7w0lLAPbSt/r7KfdvHbf4oYHSlUWE27x/u+0BOZ7cotau5IGc2Rsbil8svaXZ29tIccQ9tYwEYsqCCC2CaHYtZmUgmaHp6um/dQd/Enwl+FhICNlc9kIueXGznMpTec0EeBYuTfyXp0ewjbx7z8/O0tLTEFddyH33QN1KAoZOQhQtwm8zEhWcLPvCmpqZocXGRVlZWSNd1rrjGPbSpffFspWZQy3FBBpMhF64mZ2m3sOOXihuweP3fDxSPx933LizQ2dkZBQvuoQ190DcKkD2AYdCgl5AFMDcILsADkOfn53RdWV9f9wENtgBkfDB8OLwDhq9QzlN2f8+VihAWD/qPCHPxodWiWHPfHGVukQGM5QujBM3F0lbBnZubC2XEVQUfAc+oTMaY0GS840IqFBbvpkjb3hxKJqCrwtwvp6c9AUYRJn9tTfYANlga6mzQoLkquL1Y2w/I0GQYPpaKukF6xWUxa3He1WKRiUEBFoM2CAnQVwxfJAAze22TpUEMGpa6bds0bAHIIhcYE2PDhRMWFw9cFqsexTAyIQYtWCAX8oGD0oEihi8SgKGPLafFrphMCpp70yJ6hwoXDitEtLjUddtUmRgWYHgKwRISVfkKnokMYERo9onNvqywV5UGeAvQLXx1VBX8YNva2prvHxEWY2xoMSK+SzKRy7jehKLDdwpgGDcsYQki1CUFAMP8XYCpaVpom/q8LFWMjYgPUlTtumyFcoG9CeiwuGt3UiKQTzg+dbwJqSwUYzUzM8PGAYDjGstf2sTTAODSFiYTCKubPh0u+Ny1YQC+zshdxd7IjRx8X+QVZEIAMTjJME3uR6/VFYB3wCc+Mo9GBrDqpvULcORu2iQDPGigIdobaaDRr0TA8MF1wzVAVSUi2BaVRExEqHydkbvOkPVj5IQxrpHr8LtGaeRUkNVkDz465oH3q0HPWJI94qZJiAzXKrjMr3LTALLcD7ahgNGqm9ZQ3LS8fnM3bSLSlRJoqGFy0J8dZaBx2A00kLqUQOOmCZ9bnXCvNsJD5UHi+3GFyhMBsJrs+fDP36NP9iQTPDaSPXiXpCzVxPuwyZ6JABh1+dWyl658/uK5D+RBkj5gfWi6sm3S6zevv8Xd5YsfS7/+wm5UZ4iEO9rQR024P/7xMUsD/Gx8wG90+95/47dXyxwMAGSVycNsGQHcVqdJ796/i+ocQmiQEewzVoA9kG130xOaPPCmZ1I2Pa3IwA2CF3Y9BnDDARa5ULftAVqvbXvsXPC2Pc5HtM3IZaFXuvJWSIRav//hO9LSGrtw8JNt7+CJoxw8cfieevAkldHoyU9PxnFU6TZJQ2+ApQKst3+8pWK5qByd6lYcnWqb3IY+4wB2Yhl8X0dQiejBPRBf73Tl/8YjNDN/aKmsAAAAAElFTkSuQmCC" />
            </a><br />
            This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
