<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="author" content="Craig Gidney">
    <meta name="keywords" content="computer science,algorithms,quantum computing,blog">
    <meta name="description" content="Craig Gidney's computer science blog">
    <title>Protecting Control Flow with Nested Evals</title>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <meta name="viewport" content="width=device-width">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <!-- RSS autodiscovery -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

    <!-- Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-48771413-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <div class="header">
      <a href="/"><img src="/assets/banner.png" alt="Algorithmic Assertions - Craig Gidney's Computer Science Blog" id="site_banner"/></a>
    </div>
    <div class="site">

      <h1 class="post_title">Protecting Control Flow with Nested Evals</h1>
<p class="meta">27 Mar 2016</p>

    <!-- MathJax latest -->
    <script async type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$','$']],
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        },
        TeX: {
          Macros: {
            ket: ["\\left|{#1}\\right\\rangle", 1],
            bra: ["\\left\\langle{#1}\\right|", 1],
            parens: ["\\left({#1}\\right)", 1],
            bracket: ["\\left[{#1}\\right]", 1],
            brace: ["\\left\\{ {#1} \\right\\}", 1],
            Sum: ["\\underset{#1}{\\overset{#2}{\\Sigma}}", 2],
            bimat: ["\\begin{bmatrix} {#1} & {#2} \\\\ {#3} & {#4} \\end{bmatrix}", 4]
          }
        }
      });
    </script>
    <noscript>
      <font color=red>
        MathJax was blocked.
        Formulas like <strong>$\frac{a}{b}$</strong> won't render into <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAYCAIAAACjjJBEAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAFnSURBVDhPY/hPCCBU/P1wamJqZFpBTnJcqLl9142fUHGYip93Znopuc55+Pv/zyv16kJ+W99DJaAq/r3bGiLA67cFJPxuo5eI8bSHf8ASQABR8e1krhSr+ZwnQOGvx9LlFPNPvnv37vs/sBxExc/rrToy8Ye+/P/7ekeKFK/H2guLsvuvQlwCdcefF1sKPX3ic8qaJkzKsTcPSKzY8PQ3RArmUtyAWioYcAOoCvyAyiq+nusIVGdl0O6+/QsqAgYoZnw5nCSlkHfqG5QLAcgqflyuVZeI3PMJyoUCJBV/Hk43YRFySSvIDHXyrNr75i9EGKHi35t1HvxKxUc+/vv/cYe/qNGEu5CIQaj4cjBBSrn03HewYUZsStWXfoDF4Sp+351gKB688yMwOb5c4cwlmngA6h64ir9P59lr5Jz89v/nrQnWsl4LH0MjH8mWvx9OdEUFJ6TEhGXPu/IFkr5AAKECO/j/HwCRTZMPA+AaqQAAAABJRU5ErkJggg==" />.
      </font>
      <br>
      Allow scripts from <strong>algorithmicassertions.com</strong> and <strong>mathjax.org</strong> to fix.
      <hr/>
    </noscript>

<div class="post">
<p>Javascript&#39;s <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval">eval</a> function has a bad reputation, mostly (but not entirely) because of its tendency to create <a href="https://en.wikipedia.org/wiki/Code_injection">code injection attacks</a>.
In this post, I&#39;ll show a way <code>eval</code> can help <strong>defend</strong> against code-injection attacks.</p>

<p>(<em>This post is <strong>not</strong> a recommendation for eval, and <strong>won&#39;t</strong> prepare you for the many pitfalls of executing untrusted javascript.
If you&#39;re unfamiliar with injection attacks, or enjoy puzzles based on them, try out the game <a href="https://alexnisnevich.github.io/untrusted/">untrusted (&#39;the continuing adventures of Dr. Eval&#39;)</a>.</em>)</p>

<h1>Injecting Control Flow</h1>

<p>Injection attacks work in many ways, but a common method-of-action is hijacking the flow of code nested around the user-provided code.</p>

<p>For example, suppose you have a game and decide that users should be able to define some kind of custom flair to execute when they win.
You write something like this, to be maximally flexible:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">gameCode</span> <span class="o">=</span> <span class="err">`</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isWinner</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">{</span><span class="nx">userFlairCode</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="err">`</span><span class="p">;</span>
<span class="p">...</span>
<span class="nb">eval</span><span class="p">(</span><span class="nx">gameCode</span><span class="p">);</span>
</code></pre></div>
<p>But then users start entering flair code like <code>} ${code}; if (true) {</code>.
It affects the parse tree in a way you didn&#39;t expect, tampering with your intended control flow so that their flair runs unconditionally.
Even when the user loses, they appear to win.
Oops.</p>

<p>I grappled with this specific problem when writing the javascript widgets for the <a href="http://algorithmicassertions.com/quantum/2015/10/11/Bell-Tests-vs-No-Communication.html">you-vs-bell-tests-vs-no-communication post</a>.
Users can enter custom coordination strategies, and the code started off looking something like this:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">simulationCodeForWebWorker</span> <span class="o">=</span> <span class="err">`</span>
  <span class="p">...</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">RUN_COUNT</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
     <span class="kd">let</span> <span class="nx">move</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
     <span class="nx">$</span><span class="p">{</span><span class="nx">userStrategyForAlice</span><span class="p">}</span>
     <span class="nx">moves</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">move</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="err">`</span><span class="p">;</span>
</code></pre></div>
<p>Although there&#39;s really no cost to users beating the widgets by cheating (there&#39;s no leaderboard or anything like that), I was still interested in making it at least <em>slightly</em> difficult to cheat.
And that meant preventing control flow tampering, among other things.</p>

<h1>Nested Eval</h1>

<p>The workaround I used to protect the control flow is ironic, but straightforward: run the code inside an inner <code>eval</code>.
Instead of directly inserting the user&#39;s code into the text of the code-to-be-executed, have the code-to-be-executed pass the user&#39;s code as a string literal into an <code>eval</code> within the code-to-be-executed:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">simulationCodeForWebWorker</span> <span class="o">=</span> <span class="err">`</span>
  <span class="p">...</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">RUN_COUNT</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
     <span class="kd">let</span> <span class="nx">move</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
     <span class="nb">eval</span><span class="p">(</span><span class="nx">$</span><span class="p">{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">userStrategyForAlice</span><span class="p">)});</span> <span class="c1">// &lt;--- an eval within the code to evaluate</span>
     <span class="nx">moves</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">move</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="err">`</span><span class="p">;</span>
</code></pre></div>
<p>Now, if the user specifies code like <code>} if (false) {</code> in an attempt to keep the <code>moves</code> array empty, they&#39;ll instead cause a syntax error when <code>eval(&quot;} if (false) {&quot;)</code> is evaluated.
They can&#39;t tamper with the parse tree because the only thing they control is the logical contents of a string literal.</p>

<p>Of course we still have to prevent the user-entered code from breaking out of the string literal.
In the example, properly escaping the code into a string literal is delegated to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">JSON.stringify</a>.
I can&#39;t guarantee that <code>JSON.stringify</code> will work (e.g. what if a future version of javascript allowed <a href="https://developer.mozilla.org/en-US/docs/JavaScript_templates">templates</a> in all strings?) but, given <a href="http://thedailywtf.com/articles/bidding-on-security">how tricky it can be</a> to know which characters are safe and which aren&#39;t, I&#39;d rather defer to a standard function than write my own.</p>

<p>(<em>I also did other things to protect the widgets from user-entered code: running in a web worker, using a timeout, caching globals into locals, randomizing the names of variables, hiding scopes with <code>(function() { ... })()</code>, and so forth.
Despite all that, you can of course still cheat by using injection attacks.
Don&#39;t use eval around anything important.
Just don&#39;t.</em>)</p>

<h1>Summary</h1>

<p>When mixing user-defined code with your own code, inserting <code>eval(${JSON.stringify(userCode)})</code> instead of just <code>${userCode}</code> will prevent the user-defined code from hijacking the surrounding control flow.</p>

<p>It won&#39;t stop the user-defined code from tampering with global state, from hanging, from throwing exceptions, from leaking information, or from doing all the other awful things <code>eval</code> allows... but it&#39;ll stop the control flow tampering.
...Maybe.</p>

</div>

<!-- IntenseDebate comments -->

  <script>
  var idcomments_acct = '7d0006bd6a016f9a2892cc2ecc64de01';
  var idcomments_post_id = '/programming/2016/03/27/protecting-control-flow-with-nested-evals.html';
  var idcomments_post_url = 'http://algorithmicassertions.com/programming/2016/03/27/protecting-control-flow-with-nested-evals.html';
  </script>
  <span id="IDCommentsPostTitle" style="display:none"></span>
  <script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
  <noscript>
    <hr>
    <font color=red>
      Comments script blocked. Comments won't work.
    </font>
    <br/>
    Allow scripts from <strong>algorithmicassertions.com</strong> and <strong>intensedebate.com</strong> to fix.
  </noscript>




    </div>

    <table style="width: 100%;">
      <tr>
        <td align="left">
          <a href="/programming/2016/03/16/structure-batched.html">&laquo; Wrapping Structure Around Batched Methods</a>
        </td>
        <td align="right">
          <a href="/2016/04/05/copying-a-quantum-brain.html">Gradually Copying a Quantum Brain &raquo;</a>
        </td>
      </tr>
    </table>

    <div class="footer-container">
      <div class="site">
        <div class="footer">
          <div class="contact">
            by: Craig Gidney<br />
            more: <a href="/">All Posts</a>, <a href="/feed.xml">Posts Feed<img src="/assets/feed-icon.png" width="16px" alt="Posts Feed" title="Posts Feed" /></a><br/>
            meta: <a href="/about.html">About the Author/Blog</a><br/>
          </div>
          <div class="license">
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
              <img alt="Creative Commons License" style="border-width:0" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAAfCAYAAABjyArgAAAFOklEQVRo3u1aTU8bRxj2OVIs7lw4hhttlR5TpPQHkB+QiH9Q1FskqqCIVIpUCVmuoubQUKm3JrDG5sNfeA1rY3vX9noh5MpP4Ce81fOu32V2WfAHzhoTRhqx3pmdHZ595nk/ZmJEFI/FYnRfR1+J8Kf7Yye/TXvFXcqVslQ8KFDJKNFBtUxG3aAjs0r1Zo0arQZZbZOatkXNTtOttkWWbZLZanAf9K3UDX5WN0o8Vq6U47Hxjkw2TVt7KUrtaLS5vUEbmU9cP6U/0set/+5MVYC+ADev52j/sEjlik5G7ZDBarTqDGDbaVHnxCbnc4eOT4/p5Itbce18drgNfSzb4mfwLMYoV3UeE2MHQdZ2Nj2QAfAdBTnmB7daZgbWrBqzFaAB1NU3q/T056f0MP7w0lLAPbSt/r7KfdvHbf4oYHSlUWE27x/u+0BOZ7cotau5IGc2Rsbil8svaXZ29tIccQ9tYwEYsqCCC2CaHYtZmUgmaHp6um/dQd/Enwl+FhICNlc9kIueXGznMpTec0EeBYuTfyXp0ewjbx7z8/O0tLTEFddyH33QN1KAoZOQhQtwm8zEhWcLPvCmpqZocXGRVlZWSNd1rrjGPbSpffFspWZQy3FBBpMhF64mZ2m3sOOXihuweP3fDxSPx933LizQ2dkZBQvuoQ190DcKkD2AYdCgl5AFMDcILsADkOfn53RdWV9f9wENtgBkfDB8OLwDhq9QzlN2f8+VihAWD/qPCHPxodWiWHPfHGVukQGM5QujBM3F0lbBnZubC2XEVQUfAc+oTMaY0GS840IqFBbvpkjb3hxKJqCrwtwvp6c9AUYRJn9tTfYANlga6mzQoLkquL1Y2w/I0GQYPpaKukF6xWUxa3He1WKRiUEBFoM2CAnQVwxfJAAze22TpUEMGpa6bds0bAHIIhcYE2PDhRMWFw9cFqsexTAyIQYtWCAX8oGD0oEihi8SgKGPLafFrphMCpp70yJ6hwoXDitEtLjUddtUmRgWYHgKwRISVfkKnokMYERo9onNvqywV5UGeAvQLXx1VBX8YNva2prvHxEWY2xoMSK+SzKRy7jehKLDdwpgGDcsYQki1CUFAMP8XYCpaVpom/q8LFWMjYgPUlTtumyFcoG9CeiwuGt3UiKQTzg+dbwJqSwUYzUzM8PGAYDjGstf2sTTAODSFiYTCKubPh0u+Ny1YQC+zshdxd7IjRx8X+QVZEIAMTjJME3uR6/VFYB3wCc+Mo9GBrDqpvULcORu2iQDPGigIdobaaDRr0TA8MF1wzVAVSUi2BaVRExEqHydkbvOkPVj5IQxrpHr8LtGaeRUkNVkDz465oH3q0HPWJI94qZJiAzXKrjMr3LTALLcD7ahgNGqm9ZQ3LS8fnM3bSLSlRJoqGFy0J8dZaBx2A00kLqUQOOmCZ9bnXCvNsJD5UHi+3GFyhMBsJrs+fDP36NP9iQTPDaSPXiXpCzVxPuwyZ6JABh1+dWyl658/uK5D+RBkj5gfWi6sm3S6zevv8Xd5YsfS7/+wm5UZ4iEO9rQR024P/7xMUsD/Gx8wG90+95/47dXyxwMAGSVycNsGQHcVqdJ796/i+ocQmiQEewzVoA9kG130xOaPPCmZ1I2Pa3IwA2CF3Y9BnDDARa5ULftAVqvbXvsXPC2Pc5HtM3IZaFXuvJWSIRav//hO9LSGrtw8JNt7+CJoxw8cfieevAkldHoyU9PxnFU6TZJQ2+ApQKst3+8pWK5qByd6lYcnWqb3IY+4wB2Yhl8X0dQiejBPRBf73Tl/8YjNDN/aKmsAAAAAElFTkSuQmCC" />
            </a><br />
            This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
