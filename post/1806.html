<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="author" content="Craig Gidney">
    <meta name="keywords" content="computer science,algorithms,quantum computing,blog">
    <meta name="description" content="Craig Gidney's computer science blog">
    <title>Improving Block Code Distillation (Part 1)</title>
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <meta name="viewport" content="width=device-width">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <!-- RSS autodiscovery -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

    <!-- Analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-48771413-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body>
    <div class="header">
      <a href="/"><img src="/assets/banner.png" alt="Algorithmic Assertions - Craig Gidney's Computer Science Blog" id="site_banner"/></a>
    </div>
    <div class="site">

      <h1 class="post_title">Improving Block Code Distillation (Part 1)</h1>
<p class="meta">12 Jun 2018</p>

    <!-- MathJax latest -->
    <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$','$']],
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        },
        TeX: {
          Macros: {
            ket: ["\\left|{#1}\\right\\rangle", 1],
            bra: ["\\left\\langle{#1}\\right|", 1],
            parens: ["\\left({#1}\\right)", 1],
            bracket: ["\\left[{#1}\\right]", 1],
            brace: ["\\left\\{ {#1} \\right\\}", 1],
            Sum: ["\\underset{#1}{\\overset{#2}{\\Sigma}}", 2],
            bimat: ["\\begin{bmatrix} {#1} & {#2} \\\\ {#3} & {#4} \\end{bmatrix}", 4]
          }
        }
      });
    </script>
    <noscript>
      <font color=red>
        MathJax was blocked.
        Formulas like <strong>$\frac{a}{b}$</strong> won't render into <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAYCAIAAACjjJBEAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAFnSURBVDhPY/hPCCBU/P1wamJqZFpBTnJcqLl9142fUHGYip93Znopuc55+Pv/zyv16kJ+W99DJaAq/r3bGiLA67cFJPxuo5eI8bSHf8ASQABR8e1krhSr+ZwnQOGvx9LlFPNPvnv37vs/sBxExc/rrToy8Ye+/P/7ekeKFK/H2guLsvuvQlwCdcefF1sKPX3ic8qaJkzKsTcPSKzY8PQ3RArmUtyAWioYcAOoCvyAyiq+nusIVGdl0O6+/QsqAgYoZnw5nCSlkHfqG5QLAcgqflyuVZeI3PMJyoUCJBV/Hk43YRFySSvIDHXyrNr75i9EGKHi35t1HvxKxUc+/vv/cYe/qNGEu5CIQaj4cjBBSrn03HewYUZsStWXfoDF4Sp+351gKB688yMwOb5c4cwlmngA6h64ir9P59lr5Jz89v/nrQnWsl4LH0MjH8mWvx9OdEUFJ6TEhGXPu/IFkr5AAKECO/j/HwCRTZMPA+AaqQAAAABJRU5ErkJggg==" />.
      </font>
      <br>
      Allow scripts from <strong>algorithmicassertions.com</strong> and <strong>mathjax.org</strong> to fix.
      <hr/>
    </noscript>

<div class="post">
<p>This series of posts began with the discovery a mistake, and an attempt to fix the problem.
It ends with an insight into and improvement upon the original result.</p>

<p>Part 1: (this post) Resynthesizing the circuits</p>

<p>Part 2: (work in progress) Reconceptualizing the distillation</p>

<p>Part 3: (work in progress) Rebraiding the factory</p>

<h1>Noticing a mistake</h1>

<p>When I read papers describing quantum circuits, I like to test them out in my <a href="/quirk">drag-and-drop quantum circuit simulator Quirk</a>.
Quirk affords fast iterative experimentation.
It allows allows me to push the circuits around, try random ideas to make them smaller, see what makes them break, and maybe even understand what makes them work.</p>

<p>I was experimentating on circuits from the paper <a href="https://arxiv.org/abs/1301.7107">&quot;Surface code implementation of block code state distillation&quot;</a> when I found a problem: the circuits didn&#39;t work as advertised.
The mistake happens right near the beginning of the paper, in figure 1:</p>

<p><img src="/assets/2018-06-12-better-block-coding/fowler-fig-1.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></p>

<p>When I <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C1%2C1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C1%2C%22X%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%5D%2C%5B%22%E2%80%A2%22%2C1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C%22%7E8luc%22%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7El6e7%22%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7E8luc%22%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7El6e7%22%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%7E8luc%22%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7El6e7%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%7E8luc%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%7El6e7%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C1%2C1%2C1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Bloch%22%2C%22Bloch%22%2C%22Bloch%22%2C%22Bloch%22%5D%5D%2C%22gates%22%3A%5B%7B%22id%22%3A%22%7El6e7%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22X%22%2C%22%E2%80%A2%22%5D%5D%7D%7D%2C%7B%22id%22%3A%22%7Eppii%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22X%22%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%5D%7D%7D%2C%7B%22id%22%3A%22%7E8luc%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22%E2%80%A2%22%2C1%2C%22X%22%5D%5D%7D%7D%5D%7D">entered this circuit into Quirk</a>, I wasn&#39;t able to get it to do what it was supposed to do.
At first I figured this was because I simply hadn&#39;t found the correct feedback operations (annoyingly, the figure leaves out all of the classical fixup that happen after the measurements).
But gradually it became clear that the problem was in the circuit itself.</p>

<p>The method I used to convince myself that a mistake really is present was to realize that, since this circuit is supposed to detect single errors, inserting a Z gate next to one of the T gates should change the set of possible measurement outcomes.
Otherwise the error would be undetectable.
By just eyeballing the states while dragging a Z gate around (thanks, Quirk!), I was able to find several T gates where inserting a Z error doesn&#39;t change the possible measurement results.
Therefore the circuit is wrong.</p>

<p>For example, there is no change in possible results <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C1%2C1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C1%2C%22X%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%5D%2C%5B%22%E2%80%A2%22%2C1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C%22%7E8luc%22%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7El6e7%22%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7E8luc%22%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7El6e7%22%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%7E8luc%22%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7El6e7%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%7E8luc%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%7El6e7%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%5Et%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B%22Amps9%22%5D%2C%5B%5D%2C%5B%5D%2C%5B%5D%2C%5B%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C1%2C1%2C1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Bloch%22%2C%22Bloch%22%2C%22Bloch%22%2C%22Bloch%22%5D%5D%2C%22gates%22%3A%5B%7B%22id%22%3A%22%7El6e7%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22X%22%2C%22%E2%80%A2%22%5D%5D%7D%7D%2C%7B%22id%22%3A%22%7Eppii%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22X%22%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%5D%7D%7D%2C%7B%22id%22%3A%22%7E8luc%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22%E2%80%A2%22%2C1%2C%22X%22%5D%5D%7D%7D%5D%7D">when adding a Z gate after the third inverse T gate</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C1%2C1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C1%2C%22X%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%5D%2C%5B%22%E2%80%A2%22%2C1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C%22%7E8luc%22%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7El6e7%22%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7E8luc%22%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7El6e7%22%2C1%2C%22%7Eppii%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%7E8luc%22%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7El6e7%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%7E8luc%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%7El6e7%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%5Et%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B%22Amps9%22%5D%2C%5B%5D%2C%5B%5D%2C%5B%5D%2C%5B%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C1%2C1%2C1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Bloch%22%2C%22Bloch%22%2C%22Bloch%22%2C%22Bloch%22%5D%5D%2C%22gates%22%3A%5B%7B%22id%22%3A%22%7El6e7%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22X%22%2C%22%E2%80%A2%22%5D%5D%7D%7D%2C%7B%22id%22%3A%22%7Eppii%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22X%22%2C1%2C1%2C1%2C%22%E2%80%A2%22%5D%5D%7D%7D%2C%7B%22id%22%3A%22%7E8luc%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22%E2%80%A2%22%2C1%2C%22X%22%5D%5D%7D%7D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/indistinguishable.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>The fact that this mistake happens in figure 1 of the paper is very unfortunate, because the paper just keeps building and building on this figure.
The one initial mistake poisons <em>all</em> of the presented details.
(<a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C1%2C%22X%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%5D%2C%5B%22%E2%80%A2%22%2C1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%7E8udq%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7E8udq%22%5D%2C%5B1%2C1%2C1%2C%22%7Ekkga%22%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%7El6e7%22%2C1%2C%22%7El6e7%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7Ekkga%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%7El6e7%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%2C%22Z%5E-%C2%BC%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B1%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22X%22%2C1%2C1%2C1%2C%22%E2%80%A2%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22X%22%2C1%2C1%2C1%2C%22%E2%80%A2%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Chance%22%2C%22Chance%22%2C%22Chance%22%2C%22Chance4%22%5D%2C%5B%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C1%2C1%2C1%2C1%2C%22Bloch%22%2C%22Bloch%22%5D%5D%2C%22gates%22%3A%5B%7B%22id%22%3A%22%7El6e7%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22X%22%2C%22%E2%80%A2%22%5D%5D%7D%7D%2C%7B%22id%22%3A%22%7Ekkga%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22%E2%80%A2%22%2C1%2C%22X%22%5D%5D%7D%7D%2C%7B%22id%22%3A%22%7E8udq%22%2C%22circuit%22%3A%7B%22cols%22%3A%5B%5B%22X%22%2C1%2C%22%E2%80%A2%22%5D%5D%7D%7D%5D%7D">The k=2 case works, though!</a>)
That being said, as we will see by the end of this trilogy of posts, the high-level conclusions of the paper do survive the correction of the mistake.</p>

<p>I happen to work with Austin Fowler, who is the lead author of the paper, so it was very easy to bring the mistake to his attention.
He acknowledged the problem, pointed me at the paper that they had intended to implement (<a href="https://arxiv.org/abs/1209.2426">&quot;Magic state distillation with low overhead&quot;</a> by Bravi et al in 2012), and asked me to look into how hard it would be to fix the issue.</p>

<h1>Rederiving the circuit</h1>

<p>I wish I could say that I carefully went through the Bravi et al paper, worked through all the logic, and understood the underlying ideas.
But <em>actually</em> what I did was skim through the paper, spot equation 3, and go &quot;Ah! I bet that&#39;s it!&quot;:</p>

<p><img src="/assets/2018-06-12-better-block-coding/bravi-eq-3.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></p>

<p>The above may not look like much, but this pattern of &quot;several columns with different combinations of 1s&quot; is very reminiscent of how some T state distillation works.
Basically, T state distillation circuits often amount to creating several qubits in the $|+\rangle$ state and then applying T gates to various parity combinations of those qubits.
I figured the matrix was saying which parities to phase (e.g. if we associate the rows with qubits $Q_0$ through $Q_4$, then the first column is saying we need to apply a T gate to $Q_0 \oplus Q_2$).</p>

<p>I threw together <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Amps1%22%2C%22Amps1%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%5D%5D%7D">a circuit in Quirk based entirely on this guess</a>, did some quick experimenting to figure out the classical decoding, and... it works!</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Amps1%22%2C%22Amps1%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/initial-14-to-2-abbreviated.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>(Click the image to view the entire circuit in Quirk.)</p>

<p>The above circuit uses 14 T gates and produces two $|T^\dagger\rangle$ states.
And if you insert exactly one Z error next to one of the T gates, the error will be caught by the post-selections.
(I am assuming that the T gates are the only noisy operations, and that they can only produce Z-type errors.
This is consistent with what actually happens when injecting T states in the surface code.)
The circuit is producing the right amount of states with the right amount of error detection; it is correct.</p>

<p>Here is one example of how a Z error will ultimately toggle one of the qubits that are measured when determining whether or not to keep the output:</p>

<p><img src="/assets/2018-06-12-better-block-coding/initial-14-to-2-abbreviated-with-error.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></p>

<p>So this fixed-size case works, but we&#39;re <em>supposed</em> to be creating an extendable construction.
One with some parameter $k$ that determines how many states we make.
Clearly it is necessary to carefully read the rest of the paper.</p>

<p>Anyways, skimming further into the paper, I spotted equations 24 and 25.
They give a recipe for putting together matrices with sizes controlled by a parameter $k$:</p>

<p><img src="/assets/2018-06-12-better-block-coding/bravi-eqs-24-25.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></p>

<p>Once again, I threw together a circuit in Quirk based on my guess that the columns of the matrix were indicating which parities to phase.
Getting the decoding right was a bit harder this time; some of the check qubits ended up entangled instead of separable and had to be pulled apart in order to do the post-selection properly.</p>

<p>Anyways, after fixing that, I had a <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22H%22%5D%2C%5B%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%5D%5D%7D">working k=4 circuit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22H%22%5D%2C%5B%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/initial-20-to-4-abbreviated.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Of course, we don&#39;t want just <em>any</em> circuit.
We want a <em>good</em> circuit.
We&#39;ve validated that the original construction works, but we still haven&#39;t validated that e.g. it can be done in constant depth.
So let&#39;s do that.</p>

<h1>Optimizing the circuit</h1>

<p>In order to keep things simple, I am going to split the matrix defined by equations 25 and 26 (as well as the corresponding circuits that we&#39;re implementing) into two pieces and optimize each separately.
This works well because the columns of the matrix split nicely into a left half (with $L$ and $S_1$ sub-matrices) and a right half (with $M$ and $S_2$ sub-matrices).</p>

<p>I&#39;ll focus on finite-sized cases, but all of the steps I apply will generalize to arbitrary $k$.
In fact, even though the original paper only defines matrices for even $k$, the construction we end up with will also work for odd $k$!</p>

<p>We&#39;ll start with the left half.
Specifically, this is the matrix we&#39;ll be implementing:</p>

<p>$$
\begin{bmatrix}
M &amp; 0 \\
0 &amp; M \\
S_2 &amp; S_2
\end{bmatrix} =
\begin{bmatrix}
1 &amp; 1 &amp; 1 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
  &amp;   &amp;   &amp; 1 &amp; 1 &amp; 1 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
  &amp;   &amp;   &amp;   &amp;   &amp;   &amp; 1 &amp; 1 &amp; 1 &amp;   &amp;   &amp;   \\
  &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp; 1 &amp; 1 &amp; 1 \\
1 &amp;   &amp; 1 &amp; 1 &amp;   &amp; 1 &amp; 1 &amp;   &amp; 1 &amp; 1 &amp;   &amp; 1 \\
  &amp; 1 &amp; 1 &amp;   &amp; 1 &amp; 1 &amp;   &amp; 1 &amp; 1 &amp;   &amp; 1 &amp; 1 \\
  &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\end{bmatrix}$$</p>

<p>Which we can mechanically translate into <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">this circuit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-M-step-0.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>The circuits I have shown so far always use an ancilla qubit to perform the multi-qubit parity phasing operations.
However, when attempting to optimize a circuit, it is usually desirable to work inline without introducing an ancilla.
Instead of temporarily xoring all of the involved qubits onto a clean qubit and phasing that, we should pick one of of the involved qubits, temporarily xor the other involved qubits into the chosen qubit, and phase the chosen qubit.</p>

<p>Doing the phasing inline is particularly useful in this case because it makes it clear that some phasing operations can be done in parallel.
In particular, the fact that the &quot;M&quot; sub-matrices are laid out along a diagonal suggests that inline phasing will allow them to be done in parallel.</p>

<p>So let&#39;s try that out.
For each T gate, we need to choose which qubit to use as the inline target.
In this case, we&#39;ll just always pick the topmost involved qubit.
The <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%5D%7D">resulting circuit looks like this</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-M-step-1.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>The next step to simplifying the circuit is to group the phasing operations together based which of the two bottom qubits are involved.
(We can rearrange them because they all commute with each other.)
First we will do all the phasing operations involving just the before-bottom qubit, then all of the phasing operations involving both bottom qubits, then all of the phasing operations involving just the bottom qubit.</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%5D%7D">Here&#39;s the circuit with the operations grouped</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-M-step-2.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>The above circuit is just <em>begging</em> us to do T operations at the same time.
We can do this by taking advantage of the fact that the X-controlled-Z operations that are present all commute with each other (though not with the T gates).
In order to move a T gate leftward into the same column as another T gate, we move the X-controlled-Z operation in its way leftward first.</p>

<p>Do this in the obvious way, and rearrange the X-controlled-Z operations so that they have a nice pattern, and you get <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%5D%7D">this better structured circuit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C%22%E2%8A%96%22%2C1%2C1%2C%22Z%22%5D%2C%5B1%2C%22%E2%8A%96%22%2C1%2C1%2C1%2C%22Z%22%5D%2C%5B%22%E2%8A%96%22%2C1%2C1%2C1%2C1%2C%22Z%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-M-step-3.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>At this point it&#39;s clear that we should switch from X-axis controls and Z-axis targets to Z-axis controls and X-axis targets (i.e. use CNOT operations).
Doing so folds all of the controlled operations into just a few columns, making <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A6%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A6%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%5D%7D">a shallow circuit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A6%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A6%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-M-step-4.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>And now it&#39;s obvious that some of these controlled operations are cancelling each other out.
Do the cancellations, and we&#39;re left with <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%5D%7D">a nice short circuit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-M-step-5.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>If we had started with a larger value of $k$, i.e. more $M$ matrix columns, this final circuit would get taller instead of deeper (there would be $k$ copies of the top row).</p>

<p>Now that we&#39;ve found a nice way to optimize the circuit coming from the part of the matrix involving $M$ and $S_2$, we turn our attention to optimizing the part involving $S_1$ and $L$.
This will be a bit trickier to do, but don&#39;t worry we&#39;ll go through it step by step again.</p>

<p>This time our starting matrix is:</p>

<p>$$\begin{bmatrix}
0 &amp; L \\
0 &amp; L \\
S_1 &amp; S_1
\end{bmatrix} = \begin{bmatrix}
  &amp;   &amp;   &amp;   &amp; 1 &amp; 1 &amp; 1 &amp; 1 \\
  &amp;   &amp;   &amp;   &amp; 1 &amp; 1 &amp; 1 &amp; 1 \\
  &amp;   &amp;   &amp;   &amp; 1 &amp; 1 &amp; 1 &amp; 1 \\
  &amp;   &amp;   &amp;   &amp; 1 &amp; 1 &amp; 1 &amp; 1 \\
  &amp; 1 &amp;   &amp; 1 &amp;   &amp; 1 &amp;   &amp; 1 \\
  &amp;   &amp; 1 &amp; 1 &amp;   &amp;   &amp; 1 &amp; 1 \\
1 &amp; 1 &amp; 1 &amp; 1 &amp; 1 &amp; 1 &amp; 1 &amp; 1 \\
\end{bmatrix}
$$</p>

<p>from which, keeping in mind that this part of the matrix will be at the start of our circuit, we mechnically <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">derive a starting point</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-0.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>The first thing we&#39;re going to do is try to simplify the top-right section of the circuit, because it keeps reusing the same combination of qubits again and again.
Instead of depending on every one of those qubits for every phasing operation, we can xor them all into a single target qubit and then only include that one.
<a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">This is the resulting circuit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-1.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Now look carefully at the left operation we introduced in the previous step.
It has an X-axis control being applied to a qubit that started as $|0\rangle$ and was then transitioned to the $|+\rangle$ state by a Hadamard operation.
Applying an X-axis control to the $|+\rangle$ state is akin to applying a Z-axis control to the $|0\rangle$ state: the control is not satisfied, and all linked operations do not happen.</p>

<p>Therefore we can <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">simply drop the operation</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-2.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>And, suddenly, we see that the top three Hadamards can be moved all the way to the right side of the circuit.
The <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">resulting circuit</a> has an initial part that is independent of $k$ (!), and then a single controlled operation that depends on $k$:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-3.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Now comes the time to switch to inline phasing.
This time it&#39;s a bit harder to pick which qubits to use as the targets.
And actually, because we&#39;re going to end up doing four operations at a time, one of the operations needs to continue to use an ancilla!
But, with a bit of foresight, we inline the phases in the way that produces <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">this circuit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-4.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>This time it&#39;s not so obvious how to move the X-controlled-Z operations out of the way, so that the T gates can be combined into columns.
We start by <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">combining the T gates that are easy to get together</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-5.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Now we do two key moves.
First, we propagate the second X-controlled-Z (the one going from qubit #4 to qubit #7) rightward.
This cancels out several Zs, allows a trapped T gate to be combined with the others, and makes the left part of the circuit <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">look more like the middle part</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-6.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>The second key move is to realize that, although the triple-Z observables do not commute with the operation to their left, they do commute with the <em>pair</em> of operations to their left.
This allows the final T gates to be <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">moved into place</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-7.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Now that the T gates are in columns, our goal is to simplify the surrounding controlled operations.
If you play around with the middle section for awhile, you will find that the operations on the left can be cancelled against the operations on the right at the cost of creating extra operations targeting the fourth qubit.
Basically, keep playing until you end up with <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">this circuit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-8.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Of course, the middle is now much better <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">represented with a single multi-target CNOT</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-9.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Next!
Okay, see the first two controlled operations?
They have controls that aren&#39;t satisfied.
They can be dropped, producing <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">a shorter circuit</a>.</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-10.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>At this point it is clear that the bottom part of the circuit is preparing some kind of special state, which is then being expanded at the end of the circuit.
What is this special state?</p>

<p>By <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22Amps1%22%2C%22Amps1%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">adding a couple displays into the circuit</a>, it becomes clear what&#39;s going on:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Z%22%2C1%2C1%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22Amps1%22%2C%22Amps1%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-11.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<ol>
<li><p>The bottom qubit ends up Off, which makes sense since we were only using it as a temporary ancilla.</p></li>
<li><p>The second-to-bottom qubit is ending up in the $|+\rangle$ state.
That indicates that it&#39;s supposed to be a check qubit.</p></li>
<li><p>The next three qubits are being prepared into a superposition with equal magnitude on each of the eight possible computational basis state.
However, the phases are not all the same: the $|000\rangle$ state has opposite phase to the rest. They nearly form a $|CCZ\rangle$ state (a state used to apply Toffoli gates in an error-detecting fashion), but normally the negative sign would be on the $|111\rangle$ state, not the $|000\rangle$ state.
I call this slightly different state a $|\overline{CCZ}\rangle$ state (the overbar indicates that it&#39;s an &quot;inverse&quot; CCZ).</p></li>
</ol>

<p>In the next post, I&#39;ll talk more about the significance of this $|\overline{CCZ}\rangle$ state and how recognizing it allowed me to understand in a simple way what the block code is actually doing.
For now, let&#39;s move on with optimizing the circuit.</p>

<p>Our next optimization is an easy one, once you spot it.
The last operation on the second-to-bottom qubit, the one that ends up in a $|+\rangle$ state, is a controlled operation that does nothing when said qubit is in the $|+\rangle$ state.
So... <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22Amps1%22%2C%22Amps1%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">drop that operation</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C1%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22Amps1%22%2C%22Amps1%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-12.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>For reasons that will become obvious in the next step, we now turn the two lonely X-controlled-Zs into a multi-target CNOT, and <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22Amps1%22%2C%22Amps1%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">propagate it leftward a bit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22Amps1%22%2C%22Amps1%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-13.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Now, notice that currently the bottom qubit is not used for anything at the end of the circuit.
It is simply being uncomputed and then discarded.
Therefore, instead of uncomputing it, we can get rid of it with erasure.
That is to say, instead of discarding it we do a measurement that aligns with the final operations on it and then use the deferred measurement principle to propagate the measurement over that final operation.
This is particularly beneficial because the classically-controlled operations we end up with in <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Measure%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22Amps1%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">the resulting circuit</a> are all Pauli operations, which can be propagated around the circuit very easily:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C1%2C%22Measure%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22Amps1%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-14.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>The last thing we need to do is something we probably should have done from the start: measure that the qubit that&#39;s supposed to end up in the $|+\rangle$ state does in fact end up in the $|+\rangle$ state.
This gives us our <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Measure%22%2C%22Measure%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D">optimized left-half circuit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Measure%22%2C%22Measure%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-L-step-15.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Now all we need to do is put this $L$ and $S_1$ piece together with the $M$ and $S_2$ piece.</p>

<h1>Putting the pieces together</h1>

<p>We have our separately optimized both halves of the circuit.
We can combine them into a <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Measure%22%2C%22Measure%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A6%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps2%22%5D%5D%7D">single circuit</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22Measure%22%2C%22Measure%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%22%2C%22Z%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B1%2C1%2C1%2C%22Amps3%22%2C1%2C1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Z%22%2C%22Z%22%2C%22Z%22%2C%22%E2%8A%96%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C1%2C%22%E2%80%A6%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C1%2C%22%E2%80%A2%22%5D%2C%5B%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps2%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-C-step-0.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Currently, increasing the parameter $k$ would extend the circuit upward.
I&#39;d rather the circuit grow downward, so let&#39;s <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps3%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C%22Amps2%22%2C1%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D">flip everything vertically</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps3%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C%22Amps2%22%2C1%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-C-step-1.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Now we need to figure out the error decoding.
See how the top two used qubits on the right side are ending up in the state $|00\rangle - |01\rangle - |10\rangle - |11\rangle$?
We don&#39;t want that.
We want a separable state.</p>

<p>One way we could fix this is to apply a CZ to the two qubits, separating them into $|-\rangle$ states.
But solving the problem in that way will lead us down a bad path.
(Trust me, I tried.)
Instead of doing that, all we need to do is insert a NOT gate... at the right place.</p>

<p>I should point out that I certainly wouldn&#39;t <em>expect</em> inserting a NOT gate to do anything useful here.
The only reason I know it works is because Quirk makes it quick and easy to tweak the circuit and see how the output changes.
As a result, I&#39;m always deleting gates, adding gates, and dragging gates around just to see if they have some useful effect.
It sounds completely dumb, but it pays off <em>all the time</em> and right here right now we have a particularly good example of that.
In fact, the most serendipitous consequence of this change will only appear after several more steps.</p>

<p>For now, let&#39;s separate the outputs by <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps3%22%5D%2C%5B%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C%22Amps2%22%2C1%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D">inserting the magic NOT gate</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps3%22%5D%2C%5B%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C%22Amps2%22%2C1%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-C-step-2.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Now that the outputs are separated, we can <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps3%22%5D%2C%5B%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C%22Measure%22%2C%22Measure%22%5D%2C%5B1%2C1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D">post-select on them to detect errors</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps3%22%5D%2C%5B%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C%22Measure%22%2C%22Measure%22%5D%2C%5B1%2C1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-C-step-3.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>And we might as well <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D">do all the measurements and post-selection in the same place</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-C-step-4.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Which brings us back to that NOT gate.
It turns out that, when you extend the circuit down by two steps, increasing $k$ from 4 to 6, you have to remove the NOT gate.
Otherwise the output ends up in that state we didn&#39;t want, again.</p>

<p>In order to extend to $k=6$, <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%80%A6%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D">delete the NOT gate</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%80%A6%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-C-step-5.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>If we increase $k$ by two more, to 8, then the NOT gate is needed again.
And the pattern continues like that, where you need the NOT gate for multiples of 4 but not for numbers equal to 2 mod 4.</p>

<p>Now, if you remember where these circuits came from, you might also remember that they were only defined for even values of $k$.
So there&#39;s no reason to expect them to generalize to odd values of $k$.
But we have a <em>very</em> suggestive pattern here: if you go two steps, you rotate around X by an additional 180 degrees.
So, that might... <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%5E-%C2%BD%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D">that might just mean...</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%5E-%C2%BD%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-C-step-6.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>...you can make the circuit work in the odd cases by using 90 degree rotations!</p>

<p>Without the ability to experiment quickly in Quirk, I would never have found the location where that X gate goes.
That was a key element in finding this generalization.
I think this is a strong indicator that we need more tools like Quirk with a heavy focus on fast feedback and exploration... but I digress.</p>

<p>Before we finish, let&#39;s make just one more exploration-based improvement.
By experimentally deleting gates, I found that <a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%5E-%C2%BD%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D">one of the columns of CNOTs was redundant</a>:</p>

<p><a href="http://algassert.com/quirk#circuit=%7B%22cols%22%3A%5B%5B1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22%E2%80%A2%22%5D%2C%5B%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22X%5E-%C2%BD%22%5D%2C%5B1%2C1%2C1%2C1%2C1%2C%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B1%2C1%2C1%2C1%2C%22%E2%8A%96%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%2C%22Z%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C1%2C%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C1%2C1%2C1%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%2C%22Z%5E%C2%BC%22%5D%2C%5B1%2C1%2C%22%E2%80%A2%22%2C1%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B%22H%22%2C%22H%22%2C%22H%22%2C%22H%22%5D%2C%5B%22Measure%22%2C%22Measure%22%2C%22Measure%22%2C%22Measure%22%5D%2C%5B%22%E2%80%A2%22%2C%22X%22%2C%22X%22%2C%22X%22%5D%2C%5B1%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22%7C0%E2%9F%A9%E2%9F%A80%7C%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%2C%22Amps1%22%5D%5D%7D"><img src="/assets/2018-06-12-better-block-coding/optimize-C-step-7.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></a></p>

<p>Leaving us, finally, with the final construction (at least for part 1):</p>

<p><img src="/assets/2018-06-12-better-block-coding/final-circuit.png" style="max-width: 100%; border: 1px solid black; padding: 20px;"/></p>

<p>This is a very nice construction, I think.
Not only does it generalize the original construction so that it works for odd values, it also clearly demonstrates that it&#39;s possible to implement the circuit in constant depth (independent of $k$).</p>

<p>Note that I did confirm that the error detection actually works.
If you insert exactly one Z error into the circuit, anywhere next to a T gate, the post-selection will detect the error and discard the state.
Errors on the left side trigger the top-most post-selection, while errors on the right side trigger the other post-selections.
This is pretty easy to confirm for yourself by tracing out how each Z propagates through the circuit and into the error-detecting measurements.</p>

<h1>To be continued</h1>

<p>Recall from the intro that this whole thing started because I discovered a mistake in a paper.
The circuit construction I showed in this post fixes that initial mistake, but that doesn&#39;t mean we&#39;re done.
The mistake poisoned the rest of the figures in the paper; we also need to fix those.
For example, we need to translate the circuit diagram into surface code braiding diagrams.</p>

<p>But that&#39;s only going to happen in part 3.
We&#39;re going to take a slight detour first.
In part 2, I&#39;ll explain what this block code is <em>actually</em> doing and use that knowledge to reduce the number of T count of the circuit.</p>

</div>


    </div>

    <table style="width: 100%;">
      <tr>
        <td align="left">
          <a href="/post/1805">&laquo; Roulette Selection fit for a Quantum Computer</a>
        </td>
        <td align="right">
          
        </td>
      </tr>
    </table>

    <div class="footer-container">
      <div class="site">
        <div class="footer">
          <div class="contact">
            by: Craig Gidney<br />
            more: <a href="/">All Posts</a>, <a href="/feed.xml">Posts Feed<img src="/assets/feed-icon.png" width="16px" alt="Posts Feed" title="Posts Feed" /></a><br/>
            meta: <a href="/about.html">About the Author/Blog</a><br/>
          </div>
          <div class="license">
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
              <img alt="Creative Commons License" style="border-width:0" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAAfCAYAAABjyArgAAAFOklEQVRo3u1aTU8bRxj2OVIs7lw4hhttlR5TpPQHkB+QiH9Q1FskqqCIVIpUCVmuoubQUKm3JrDG5sNfeA1rY3vX9noh5MpP4Ce81fOu32V2WfAHzhoTRhqx3pmdHZ595nk/ZmJEFI/FYnRfR1+J8Kf7Yye/TXvFXcqVslQ8KFDJKNFBtUxG3aAjs0r1Zo0arQZZbZOatkXNTtOttkWWbZLZanAf9K3UDX5WN0o8Vq6U47Hxjkw2TVt7KUrtaLS5vUEbmU9cP6U/0set/+5MVYC+ADev52j/sEjlik5G7ZDBarTqDGDbaVHnxCbnc4eOT4/p5Itbce18drgNfSzb4mfwLMYoV3UeE2MHQdZ2Nj2QAfAdBTnmB7daZgbWrBqzFaAB1NU3q/T056f0MP7w0lLAPbSt/r7KfdvHbf4oYHSlUWE27x/u+0BOZ7cotau5IGc2Rsbil8svaXZ29tIccQ9tYwEYsqCCC2CaHYtZmUgmaHp6um/dQd/Enwl+FhICNlc9kIueXGznMpTec0EeBYuTfyXp0ewjbx7z8/O0tLTEFddyH33QN1KAoZOQhQtwm8zEhWcLPvCmpqZocXGRVlZWSNd1rrjGPbSpffFspWZQy3FBBpMhF64mZ2m3sOOXihuweP3fDxSPx933LizQ2dkZBQvuoQ190DcKkD2AYdCgl5AFMDcILsADkOfn53RdWV9f9wENtgBkfDB8OLwDhq9QzlN2f8+VihAWD/qPCHPxodWiWHPfHGVukQGM5QujBM3F0lbBnZubC2XEVQUfAc+oTMaY0GS840IqFBbvpkjb3hxKJqCrwtwvp6c9AUYRJn9tTfYANlga6mzQoLkquL1Y2w/I0GQYPpaKukF6xWUxa3He1WKRiUEBFoM2CAnQVwxfJAAze22TpUEMGpa6bds0bAHIIhcYE2PDhRMWFw9cFqsexTAyIQYtWCAX8oGD0oEihi8SgKGPLafFrphMCpp70yJ6hwoXDitEtLjUddtUmRgWYHgKwRISVfkKnokMYERo9onNvqywV5UGeAvQLXx1VBX8YNva2prvHxEWY2xoMSK+SzKRy7jehKLDdwpgGDcsYQki1CUFAMP8XYCpaVpom/q8LFWMjYgPUlTtumyFcoG9CeiwuGt3UiKQTzg+dbwJqSwUYzUzM8PGAYDjGstf2sTTAODSFiYTCKubPh0u+Ny1YQC+zshdxd7IjRx8X+QVZEIAMTjJME3uR6/VFYB3wCc+Mo9GBrDqpvULcORu2iQDPGigIdobaaDRr0TA8MF1wzVAVSUi2BaVRExEqHydkbvOkPVj5IQxrpHr8LtGaeRUkNVkDz465oH3q0HPWJI94qZJiAzXKrjMr3LTALLcD7ahgNGqm9ZQ3LS8fnM3bSLSlRJoqGFy0J8dZaBx2A00kLqUQOOmCZ9bnXCvNsJD5UHi+3GFyhMBsJrs+fDP36NP9iQTPDaSPXiXpCzVxPuwyZ6JABh1+dWyl658/uK5D+RBkj5gfWi6sm3S6zevv8Xd5YsfS7/+wm5UZ4iEO9rQR024P/7xMUsD/Gx8wG90+95/47dXyxwMAGSVycNsGQHcVqdJ796/i+ocQmiQEewzVoA9kG130xOaPPCmZ1I2Pa3IwA2CF3Y9BnDDARa5ULftAVqvbXvsXPC2Pc5HtM3IZaFXuvJWSIRav//hO9LSGrtw8JNt7+CJoxw8cfieevAkldHoyU9PxnFU6TZJQ2+ApQKst3+8pWK5qByd6lYcnWqb3IY+4wB2Yhl8X0dQiejBPRBf73Tl/8YjNDN/aKmsAAAAAElFTkSuQmCC" />
            </a><br />
            This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
